<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Order Management System</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; background-color: #fff; color: #333;
    display: flex; height: 100vh;
  }
  #sidebar {
    width: 350px; background-color: #d3d3d3;
    padding-top: 20px; display: flex; flex-direction: column; gap: 15px; box-sizing: border-box;
  }
  #sidebar button {
    background: none; border: none; text-align: left;
    padding: 12px 18px; font-weight: bold; cursor: pointer; font-size: 1.15em;
  }
  #sidebar button:hover,
  #sidebar button.active { background-color: #bbb; }
  #main {
    flex-grow: 1; padding: 20px; overflow: auto;
  }
  h1 {
    text-align: center; font-weight: normal; margin-bottom: 20px;
  }
  table {
    width: 100%; border-collapse: collapse; font-size: 0.90em;
  }
  th, td {
    border: 1px solid #ddd; padding: 8px 12px; text-align: left;
  }
  th {
    background-color: #e77517; color: black;
  }
  tr:hover { background-color: #f1f1f1; }
  .status-paid { color: green; font-weight: bold; }
  .status-pending { color: orange; font-weight: bold; }
  .btn-small {
    padding: 5px 10px; font-size: 0.95em; margin-left: 5px;
    cursor: pointer; border-radius: 4px;
  }
  .btn-invoice {
    background-color: #0078d4; color: white; border: none;
  }
  .btn-delete {
    background-color: #d9534f; color: white; border: none;
  }
  form {
    max-width: 500px; background: #fff; padding: 18px;
    border-radius: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    margin: 20px auto; text-align: center;
  }
  label {
    display: block; margin: 10px 0 5px; font-weight: bold; text-align: left;
  }
  input[type="text"], input[type="number"], select {
    width: 100%; padding: 8px 10px; box-sizing: border-box;
    border-radius: 2px; border: 1px solid #ccc;
  }
  button[type="submit"] {
    background-color: #0078d4; color: white; border: none;
    padding: 10px 30px; margin-top: 15px; border-radius: 4px;
    cursor: pointer; font-weight: bold; display: inline-block;
  }
  button[type="submit"]:disabled { background-color: #bbb; }
  .content-section { display: none; }
  .content-section.active { display: block; }
  #search-bar {
    position: relative; display: flex; justify-content: center; margin-bottom: 10px;
  }
  #search-container {
    position: relative; width: 350px;
  }
  #search_keyword {
    width: 350px; padding: 8px 10px; border-radius: 2px; border: 1px solid #ccc;
    box-sizing: border-box;
  }
  #suggestions {
    position: absolute; top: 38px; left: 0; right: 0;
    background: white; border: 1px solid #ccc; border-top: none;
    border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto;
    z-index: 1000; display: none;
  }
  #suggestions div {
    padding: 8px 10px; cursor: pointer;
  }
  #suggestions div:hover { background-color: #f1f1f1; }
  #btn-search, #btn-filter {
    padding: 10px 30px; font-weight: bold; border-radius: 4px; background: #0078d4;
    color: white; border: none; cursor: pointer; margin-left: 8px;
  }
  /* Invoice modal */
  #invoiceModal {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.15); align-items: center; justify-content: center; z-index: 9999;
  }
  #invoiceContent {
    background: #fff; border-radius: 8px; padding: 32px 32px 40px 32px;
    min-width: 350px; max-width: 480px; margin: auto; position: relative;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); text-align: left;
  }
  #invoiceClose {
    position: absolute; top: 8px; right: 18px; cursor: pointer;
    font-size: 24px; color: #222; font-weight: bold;
  }
  #downloadInvoiceBtn {
    margin-top: 20px; background-color: #0078d4; border: none;
    color: white; padding: 10px 20px; cursor: pointer;
    border-radius: 4px; font-weight: bold; display: block;
  }
  #filter-bar {
  display: flex;
  justify-content: center;
  position: relative;
}
#filter-container {
  position: relative;
  width: 350px;
}
#filter_container input, #filter-container input {
  width: 100%;
  padding: 8px 10px;
  border-radius: 2px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}
#btn-filter {
  padding: 10px 30px;
  font-weight: bold;
  border-radius: 4px;
  background: #0078d4;
  color: white;
  border: none;
  cursor: pointer;
  margin-left: 8px;
  height: 40px;
}

</style>
</head>
<body>

<div id="sidebar">
  <button id="btn-create-order">Create New Order</button>
  <button id="btn-orders" class="active">Orders</button>
  <button id="btn-update-payment">Update Payment</button>
  <button id="btn-update-stage">Update Project Stage</button>
  <button id="btn-search-orders">Search Orders</button>
  <button id="btn-filter-remaining">Filter by Remaining %</button>
</div>

<div id="main">
  <h1>ORDER MANAGEMENT SYSTEM</h1>
  
  <section id="section-create-order" class="content-section">
    <form id="form-create-order">
      <label for="order_id">Order ID (Unique)</label>
      <input type="text" id="order_id" required />
      <label for="project_name">Project Name</label>
      <input type="text" id="project_name" required />
      <label for="architect_name">Architect Name</label>
      <input type="text" id="architect_name" required />
      <label for="client_name">Client Name</label>
      <input type="text" id="client_name" />
      <label for="client_phone">Client Phone</label>
      <input type="text" id="client_phone" />
      <label for="client_gst">Client GST Number</label>
      <input type="text" id="client_gst" />
      <label for="client_address">Client Address</label>
      <input type="text" id="client_address" />
      <label for="total_amount">Total Amount</label>
      <input type="number" id="total_amount" min="0" step="0.01" required />
      <label for="amount_paid">Amount Paid</label>
      <input type="number" id="amount_paid" min="0" step="0.01" required />
      <button type="submit">Create Order</button>
      <div id="create-msg" role="alert"></div>
    </form>
  </section>

  <section id="section-update-payment" class="content-section">
    <form id="form-update-payment">
      <label for="upd_order_id">Order ID</label>
      <input type="text" id="upd_order_id" required />
      <label for="upd_amount_paid">New Payment Amount</label>
      <input type="number" id="upd_amount_paid" min="0" step="0.01" />
      <button type="submit">Update Payment</button>
      <div id="update-payment-msg" role="alert"></div>
    </form>
  </section>

  <section id="section-update-stage" class="content-section">
    <form id="form-update-stage">
      <label for="upd_stage_order_id">Order ID</label>
      <input type="text" id="upd_stage_order_id" required />
      <label for="upd_stage">Project Stage</label>
      <select id="upd_stage" required>
        <option value="" disabled selected>-- Select Stage --</option>
        <option value="0">Design Review (5%)</option>
        <option value="1">Concept MEP Design (15%)</option>
        <option value="2">Detailed Design & Drawings (30%)</option>
        <option value="3">Coordination & Clash Resolution (45%)</option>
        <option value="4">Approvals (55%)</option>
        <option value="5">Procurement (65%)</option>
        <option value="6">Installation/Execution (85%)</option>
        <option value="7">Testing & Commissioning (95%)</option>
        <option value="8">Handover (100%)</option>
      </select>
      <button type="submit">Update Project Stage</button>
      <div id="update-stage-msg" role="alert"></div>
    </form>
  </section>

  <section id="section-orders" class="content-section active">
    <div id="all-orders" style="overflow-x:auto; margin-top: 15px;"></div>
  </section>

  <section id="section-search" class="content-section">
    <div id="search-bar">
      <div id="search-container">
        <input type="text" id="search_keyword" placeholder="Order ID, Project or Architect Name" autocomplete="off" />
        <div id="suggestions"></div>
      </div>
      <button id="btn-search">Search</button>
    </div>
    <div id="search-results" style="overflow-x:auto; margin-top: 15px;"></div>
  </section>

<section id="section-filter" class="content-section">
  <div id="filter-bar">
    <div id="filter-container">
      <input type="number" id="filter_percent" min="0" max="100" step="1" placeholder="Remaining %" />
    </div>
    <button id="btn-filter">Filter</button>
  </div>
  <div id="filter-results" style="overflow-x:auto; margin-top: 15px;"></div>
</section>

</div>

<div id="invoiceModal">
  <div id="invoiceContent">
    <span id="invoiceClose" onclick="closeInvoiceModal()">×</span>
    <div id="invoiceFields"></div>
    <button id="downloadInvoiceBtn" onclick="downloadInvoicePDF()">Download PDF</button>
  </div>
</div>

<script>
const API_BASE = "http://localhost:8001";

const btnCreateOrder = document.getElementById('btn-create-order');
const btnUpdatePayment = document.getElementById('btn-update-payment');
const btnUpdateStage = document.getElementById('btn-update-stage');
const btnOrders = document.getElementById('btn-orders');
const btnSearchOrders = document.getElementById('btn-search-orders');
const btnFilterRemaining = document.getElementById('btn-filter-remaining');

const sections = {
  create: document.getElementById('section-create-order'),
  updatePayment: document.getElementById('section-update-payment'),
  updateStage: document.getElementById('section-update-stage'),
  orders: document.getElementById('section-orders'),
  search: document.getElementById('section-search'),
  filter: document.getElementById('section-filter'),
};

function showSection(name) {
  Object.values(sections).forEach(sec => sec.classList.remove('active'));
  sections[name].classList.add('active');
  if(name === 'orders') loadAllOrders();
}

function activateButton(btn) {
  [btnCreateOrder, btnUpdatePayment, btnUpdateStage, btnOrders, btnSearchOrders, btnFilterRemaining]
    .forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

btnCreateOrder.addEventListener('click', () => { showSection('create'); activateButton(btnCreateOrder); });
btnUpdatePayment.addEventListener('click', () => { showSection('updatePayment'); activateButton(btnUpdatePayment); });
btnUpdateStage.addEventListener('click', () => { showSection('updateStage'); activateButton(btnUpdateStage); });
btnOrders.addEventListener('click', () => { showSection('orders'); activateButton(btnOrders); });
btnSearchOrders.addEventListener('click', () => { showSection('search'); activateButton(btnSearchOrders); });
btnFilterRemaining.addEventListener('click', () => { showSection('filter'); activateButton(btnFilterRemaining); });

function formatCurrency(value) {
  return new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'}).format(value);
}

function getStageName(index) {
  const stages = [
    "Design Review", "Concept MEP Design", "Detailed Design & Drawings", "Coordination & Clash Resolution",
    "Approvals", "Procurement", "Installation/Execution", "Testing & Commissioning", "Handover"
  ];
  if(index == null || index < 0 || index >= stages.length) return "";
  return stages[index];
}

function renderOrdersTable(orders, containerId, showActions=true) {
  if(!orders.length) {
    document.getElementById(containerId).innerHTML = '<p>No orders found.</p>';
    return;
  }
  let html = `<table aria-label="Orders Table"><thead><tr>
    <th>SL No</th><th>Order ID</th><th>Project</th><th>Architect</th>
    <th>Client Name</th><th>Phone</th><th>GST No</th><th>Address</th>
    <th>Total Amount</th><th>Amount Paid</th><th>Paid %</th><th>Remaining</th>
    <th>Current Stage</th><th>Progress %</th>
    <th>Start Date</th><th>Last Invoice</th><th>End Date</th><th>Created At</th>
    <th>Status</th><th>Actions</th></tr></thead><tbody>`;

  orders.forEach((o,i) => {
    html += `<tr>
      <td>${o.sl_no || i+1}</td><td>${o.id}</td><td>${o.project_name}</td><td>${o.architect_name}</td>
      <td>${o.client_name || ""}</td><td>${o.client_phone || ""}</td><td>${o.client_gst || ""}</td><td>${o.client_address || ""}</td>
      <td>${formatCurrency(o.total_amount)}</td><td>${formatCurrency(o.amount_paid)}</td><td>${o.paid_percent.toFixed(2)}%</td><td>${formatCurrency(o.remaining_amount)}</td>
      <td>${getStageName(o.progress_stage_index)}</td><td>${o.progress_percent.toFixed(2)}%</td><td>${o.start_date}</td><td>${o.last_invoice_date}</td><td>${o.end_date || ""}</td><td>${o.created_at}</td>
      <td>${o.remaining_percent <= 0.01 ? '<span class="status-paid">Paid</span>' : '<span class="status-pending">Pending</span>'}</td>
      <td>${showActions ? `<button class="btn-small btn-invoice" onclick="viewInvoice('${o.id}')">Invoice</button>
      <button class="btn-small btn-delete" onclick="deleteOrder('${o.id}')">Delete</button>` : ''}</td>
    </tr>`;
  });

  html += '</tbody></table>';
  document.getElementById(containerId).innerHTML = html;
}

const searchInput = document.getElementById("search_keyword");
const suggestionsContainer = document.getElementById("suggestions");
const searchResultsContainer = document.getElementById("search-results");
const btnSearch = document.getElementById("btn-search");

btnSearch.addEventListener("click", () => {
  const keyword = searchInput.value.trim();
  if (!keyword) {
    alert("Enter a keyword to search");
    return;
  }
  searchResultsContainer.innerHTML = "Searching...";
  fetch(`${API_BASE}/orders/search/?keyword=${encodeURIComponent(keyword)}`)
    .then(resp => {
      if (!resp.ok) throw new Error("Search failed: " + resp.statusText);
      return resp.json();
    })
    .then(data => {
      if (data.length === 0) {
        searchResultsContainer.innerHTML = "<p>No matching orders found.</p>";
      } else {
        renderOrdersTable(data, "search-results", false);
      }
      suggestionsContainer.style.display = "none";
    })
    .catch(err => {
      searchResultsContainer.innerHTML = `<p style="color:red;">${err.message}</p>`;
    });
});

searchInput.addEventListener("input", () => {
  const val = searchInput.value.trim().toLowerCase();
  if (val.length === 0) {
    suggestionsContainer.style.display = "none";
    return;
  }
  fetch(`${API_BASE}/orders/search/?keyword=${encodeURIComponent(val)}`)
    .then(resp => resp.ok ? resp.json() : Promise.reject("Failed to fetch suggestions"))
    .then(orders => {
      suggestionsContainer.innerHTML = "";
      const shown = new Set();
      orders.forEach(order => {
        const text = `${order.project_name || ""} - ${order.architect_name || ""}`;
        if (!shown.has(text)) {
          const div = document.createElement("div");
          div.textContent = text;
          div.onclick = () => {
            searchInput.value = order.project_name || "";  // Use only project_name for search
            suggestionsContainer.style.display = "none";
            btnSearch.click();
          };
          suggestionsContainer.appendChild(div);
          shown.add(text);
        }
      });
      suggestionsContainer.style.display = orders.length ? "block" : "none";
    })
    .catch(() => {
      suggestionsContainer.style.display = "none";
    });
});

function closeInvoiceModal() {
  document.getElementById("invoiceModal").style.display = "none";
}
window.onclick = function(event) {
  if(event.target === document.getElementById("invoiceModal")) closeInvoiceModal();
}
async function viewInvoice(orderId) {
  try {
    const resp = await fetch(`${API_BASE}/orders/${orderId}/invoice_json`);
    if (!resp.ok) throw new Error(`Failed to load invoice for ${orderId}`);
    const invoice = await resp.json();
    const draftInvoiceAmount = isNaN(parseFloat(invoice.draft_invoice_amount)) ? 0 : parseFloat(invoice.draft_invoice_amount);
    const html = `
      <h3>Invoice for Order ID: ${invoice.id}</h3>
      <b>Project Name:</b> ${invoice.project_name || "N/A"}<br>
      <b>Client Name:</b> ${invoice.client_name || "N/A"}<br>
      <b>Phone:</b> ${invoice.client_phone || "N/A"}<br>
      <b>Address:</b> ${invoice.client_address || "N/A"}<br>
      <b>GST No:</b> ${invoice.client_gst || "N/A"}<br>
      <b>Work Progress:</b> ${parseFloat(invoice.progress_percent).toFixed(2)}%<br>
      <b>Work Pending:</b> ${(100 - parseFloat(invoice.progress_percent)).toFixed(2)}%<br>
      <b>Total Amount:</b> ₹${parseFloat(invoice.total_amount).toFixed(2)}<br>
      <b>Amount Paid:</b> ₹${parseFloat(invoice.amount_paid).toFixed(2)}<br>
      <b>Remaining Amount:</b> ₹${parseFloat(invoice.remaining_amount).toFixed(2)}<br>
      <b>Payable Amount for Work Done:</b> ₹${draftInvoiceAmount.toFixed(2)}<br>
    `;
    document.getElementById("invoiceFields").innerHTML = html;
    document.getElementById("invoiceModal").style.display = "flex";
    window.currentInvoiceOrderId = orderId;
  } catch(error) {
    alert(error.message);
  }
}

function downloadInvoicePDF() {
  if(window.currentInvoiceOrderId) {
    window.open(`${API_BASE}/orders/${window.currentInvoiceOrderId}/invoice_pdf`, "_blank");
  }
}

window.deleteOrder = async function(id) {
  if(!confirm(`Delete order ${id}? This action cannot be undone.`)) return;
  try {
    const resp = await fetch(`${API_BASE}/orders/${id}/`, {method: "DELETE"});
    if(!resp.ok) throw new Error(await resp.text());
    alert(`Order ${id} deleted.`);
    loadAllOrders();
  } catch(error) {
    alert(`Delete failed: ${error.message}`);
  }
}

document.getElementById("form-create-order").addEventListener("submit", async (e) => {
  e.preventDefault();
  const order_id = document.getElementById("order_id").value.trim();
  const project_name = document.getElementById("project_name").value.trim();
  const architect_name = document.getElementById("architect_name").value.trim();
  const client_name = document.getElementById("client_name").value.trim();
  const client_phone = document.getElementById("client_phone").value.trim();
  const client_gst = document.getElementById("client_gst").value.trim();
  const client_address = document.getElementById("client_address").value.trim();
  const total_amount = Number(document.getElementById("total_amount").value);
  const amount_paid = Number(document.getElementById("amount_paid").value);

  if(!order_id || !project_name || !architect_name || total_amount <= 0 || amount_paid < 0) {
    alert("Please fill out all required fields correctly.");
    return;
  }

  try {
    const resp = await fetch(`${API_BASE}/orders/`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({id:order_id, project_name, architect_name, client_name, client_phone, client_gst, client_address, total_amount, amount_paid}),
    });
    if(!resp.ok) throw new Error(await resp.text());
    const json = await resp.json();
    alert(`Order created with ID ${json.id}`);
    e.target.reset();
    loadAllOrders();
  } catch(e) {
    alert("Failed to create order: "+e.message);
  }
});

document.getElementById("form-update-payment").addEventListener("submit", async (e) => {
  e.preventDefault();
  const order_id = document.getElementById("upd_order_id").value.trim();
  const amount_paid = Number(document.getElementById("upd_amount_paid").value);

  if(!order_id) {
    alert("Order ID must be provided.");
    return;
  }
  if(isNaN(amount_paid) || amount_paid <= 0) {
    alert("Please enter a valid positive Payment Amount.");
    return;
  }

  try {
    const resp = await fetch(`${API_BASE}/orders/${order_id}/`, {
      method: "PUT",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({amount_paid}),
    });
    if(!resp.ok) throw new Error(await resp.text());
    const json = await resp.json();
    const msgDiv = document.getElementById("update-payment-msg");
    msgDiv.textContent = `Order ${json.id} updated successfully.`;
    msgDiv.style.color = "green";
  } catch(e) {
    alert("Update failed: "+e.message);
  }
});

document.getElementById("form-update-stage").addEventListener("submit", async (e) => {
  e.preventDefault();
  const order_id = document.getElementById("upd_stage_order_id").value.trim();
  const progress_stage_index = Number(document.getElementById("upd_stage").value);

  if(!order_id) {
    alert("Order ID must be provided.");
    return;
  }
  if(isNaN(progress_stage_index) || progress_stage_index < 0) {
    alert("Please select a valid Project Stage.");
    return;
  }

  try {
    const resp = await fetch(`${API_BASE}/orders/${order_id}/`, {
      method: "PUT",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({progress_stage_index}),
    });
    if(!resp.ok) throw new Error(await resp.text());
    const json = await resp.json();
    const msgDiv = document.getElementById("update-stage-msg");
    msgDiv.textContent = `Project stage for Order ${json.id} updated to "${getStageName(json.progress_stage_index)}".`;
    msgDiv.style.color = "green";
  } catch(e) {
    alert("Update failed: "+e.message);
  }
});

async function loadAllOrders() {
  try {
    const resp = await fetch(`${API_BASE}/orders/`);
    if(!resp.ok) throw new Error(await resp.text());
    const orders = await resp.json();
    renderOrdersTable(orders, "all-orders", true);
  } catch(e) {
    document.getElementById("all-orders").innerHTML = `<p style="color:red;">${e.message}</p>`;
  }
}

showSection('orders');
activateButton(btnOrders);
loadAllOrders();

</script>
</body>
</html>
